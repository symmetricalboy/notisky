<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Notisky Authentication</title>
  <style>
    body { font-family: system-ui, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 90vh; text-align: center; background-color: #f8f9fa; }
    .card { background: white; padding: 30px 40px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h1 { margin-bottom: 20px; color: #333; }
    p { color: #555; }
    .status { margin-top: 20px; font-weight: bold; }
    .success { color: #28a745; }
    .error { color: #dc3545; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Authenticating with Notisky</h1>
    <p id="message">Processing authentication callback...</p>
    <p class="status" id="status"></p>
  </div>

  <script>
    (async () => {
      const statusEl = document.getElementById('status');
      const messageEl = document.getElementById('message');
      try {
        console.log('[OAuth Callback Page] Loaded');
        statusEl.textContent = 'Reading parameters...';

        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const state = params.get('state');
        const error = params.get('error');
        const errorDescription = params.get('error_description');

        if (error) {
          console.error('[OAuth Callback Page] Received error from server:', error, errorDescription);
          messageEl.textContent = 'Authentication failed.';
          statusEl.textContent = `Error: ${error} - ${errorDescription || 'Please try again.'}`;
          statusEl.className = 'status error';
          // Don't close automatically on error, let user see the message
          return; // Stop processing
        }

        if (!code || !state) {
          throw new Error('Missing code or state parameter in callback URL.');
        }

        statusEl.textContent = 'Sending details to background service...';
        console.log('[OAuth Callback Page] Sending OAUTH_CALLBACK to background with code and state.');

        // Send message to background script
        const response = await browser.runtime.sendMessage({
          type: 'OAUTH_CALLBACK',
          data: { code, state }
        });

        console.log('[OAuth Callback Page] Background response:', response);
        // The background script will handle the token exchange and send
        // OAUTH_COMPLETE to the popup. This page just needs to indicate success.
        messageEl.textContent = 'Authentication details sent successfully!';
        statusEl.textContent = 'You can now close this window.';
        statusEl.className = 'status success';

        // Close the window after a short delay
        setTimeout(() => window.close(), 2500);

      } catch (err) {
        console.error('[OAuth Callback Page] Error:', err);
        messageEl.textContent = 'An error occurred during authentication.';
        statusEl.textContent = 'Error: ' + (err instanceof Error ? err.message : String(err));
        statusEl.className = 'status error';
        // Don't close on error
      }
    })();
  </script>
</body>
</html> 